---
title: "FLOW-MR-tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FLOW-MR-tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,  # Hides warnings
  message = FALSE   # Hides messages
)
```

# Introduction

`FLOW-MR` is an R package for performing Mendelian Randomization under the mediation setting. This tutorial demonstrates how to use the package step by step.


# Installation

```{r, message=FALSE, warning=FALSE}
# Install devtools if not installed
install.packages("devtools")

# Install FLOW-MR
devtools::install_github("ZixuanWu1/FLOW-MR")

```

# Load the Package

```{r}
library(FLOWMR)
```

# Example Usage


## Step 1: Prepare Input Data

Here, we use `GRAPPLE` to preprocess the input data. We can download the `GRAPPLE` package using the following command:

```{r}
devtools::install_github("jingshuw/grapple")
```


Next, we use `GRAPPLE` to preprocess the data following a three-sample Mendelian Randomization (MR) design. The sel.file is used to select genome-wide significant SNPs, the exp.file contains the exposures of interest, and the out.file contains the outcomes of interest. For more details, visit [GRAPPLE](https://github.com/jingshuw/GRAPPLE) on GitHub.

In this example we use adult BMI from [GIANT](https://portals.broadinstitute.org/collaboration/giant/index.php/GIANT_consortium_data_files) and childhoood BMI from [EGG](http://egg-consortium.org) as selections files. We use childhood body size and bmi adult from [UK biobank](https://www.nealelab.is/uk-biobank) as exposures, and Breast Cancer from this [paper](https://pubmed.ncbi.nlm.nih.gov/29059683) as outcome. 


```{r}
library(GRAPPLE)

# Selection file of snps
sel.file <- c("~/Downloads/research/BMI-giant17eu.csv", "~/Downloads/research/bmi_child_egg.csv" )

# Exposure file
exp.file <- c( "~/Downloads/research/childhood_body_size.csv","~/Downloads/research/BMI_adult.csv" )

# Outcome file
out.file <- "~/Downloads/research/Breast-Micha17erp.csv"

# Use plink to select independent significant SNPs
plink_refdat <- "~/Downloads/research/data_maf0.01_rs_ref/data_maf0.01_rs_ref"

## Use max.p.thres to decide the significance level of SNPs
## Use cal.cor = T to compute the noise correlation
data.list <- GRAPPLE::getInput(sel.file, exp.file, out.file, plink_refdat, max.p.thres =0.01,
                               plink_exe = "~/Downloads/research/plink_mac_20210606/plink", cal.cor = T)
```

## Step 2: Run FLOW-MR

To run FLOW-MR, we need to prepare two input files, `Gamma_hat` and `Sd_hat`. Also ensuring that the time order is reversed:

```{r}
dat <-data.list$data;

# Run the mediation method
Gamma_hat =rbind(dat$gamma_out1, 
                 dat$gamma_exp2,
                 dat$gamma_exp1)

Sd_hat = rbind(dat$se_out1, 
               dat$se_exp2,
               dat$se_exp1)

result = BayesMediation(Gamma_hat, Sd_hat, cor = data.list$cor.mat)
```

## Step 3: Look at summary of direct effects

In this step, we print the summary of direct effects, where each row corresponds to a parameter.


```{r}
print(result$summary)
```

For example, `B[1,2]` represents the effect of adult BMI on breast cancer, `B[1,3]` represents the d`irect effect of childhood BMI on breast cancer, and  `B[2,3]` represents the direct effect of childhood BMI on adult BMI. The `ESS (Effective Sample Size) quantifies the number of independent samples, while `Rhat` (the Gelman-Rubin statistic) assesses convergence.

If non-convergence issues arise (e.g., a large `Rhat` value), you can use the following command to generate a trace plot of the posterior samples:

```{r}
FLOWMR::traceplot(result$raw, par = "B", ind = c(1,2))
```

## Step 4

To estimate path-wise effects, use the following command. For example, the code below evaluates the indirect effect of childhood BMI on breast cancer through adult BMI:

```{r}
path_effect = indirect_effect(result$raw, K = 3, path = c(3,2,1),  warmup = 3000)
print(path_effect)
```

# Conclusion

This tutorial introduced the key functionalities of FLOW-MR. For more details, refer to the package documentation.
